<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>91 Download Web UI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="container app-shell py-4">
    <h1 class="mb-3 text-center">91 Download Web UI</h1>
    <p class="text-center text-secondary mb-4">
      基于 <code>91-download-api</code> 的视频解析与下载前端界面
      （参考后端项目：<a href="https://github.com/yunwuneo/91-download-api" target="_blank" rel="noreferrer">91-download-api</a>）
    </p>

    <!-- 全局配置 -->
    <div class="card mb-3 shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>全局配置</span>
        <div class="btn-group btn-group-sm">
          <button id="btnSaveConfig" class="btn btn-outline-light">
            保存配置到本地
          </button>
          <button id="btnClearConfig" class="btn btn-outline-danger">
            清除本地配置
          </button>
        </div>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">API 基础地址</label>
            <input
              id="apiBaseUrl"
              type="text"
              class="form-control"
              placeholder="例如：http://localhost:3005"
              value="http://localhost:3005"
            />
            <div class="form-text text-warning">
              末尾不要加斜杠 /
            </div>
          </div>
          <div class="col-md-4">
            <label class="form-label">API Token（可选）</label>
            <input
              id="apiToken"
              type="text"
              class="form-control"
              placeholder="与后端 .env 中 API_TOKEN 一致；未配置则可留空"
            />
          </div>
          <div class="col-md-4">
            <label class="form-label">默认输出目录</label>
            <input
              id="defaultOutputDir"
              type="text"
              class="form-control"
              placeholder="默认 data"
              value="data"
            />
          </div>
        </div>
      </div>
    </div>

    <!-- 主操作区：一键处理 / 仅解析 / 仅下载（标签页） -->
    <div class="card mb-3 shadow-sm">
      <div class="card-header">
        <ul class="nav nav-tabs border-0" id="mainTab">
          <li class="nav-item">
            <button
              class="nav-link active"
              type="button"
              data-tab-target="#tab-process"
            >
              一键处理
            </button>
          </li>
          <li class="nav-item">
            <button
              class="nav-link"
              type="button"
              data-tab-target="#tab-parse"
            >
              仅解析 M3U8
            </button>
          </li>
          <li class="nav-item">
            <button
              class="nav-link"
              type="button"
              data-tab-target="#tab-download"
            >
              仅下载 M3U8
            </button>
          </li>
        </ul>
      </div>
      <div class="card-body">
        <!-- 一键处理：解析 + 下载 + 存储 -->
        <div id="tab-process" class="tab-pane active">
          <div class="row g-3 align-items-end">
            <div class="col-md-6">
              <label class="form-label">页面 URL（支持单个或批量，每行一个，当前仅支持 hsex.men）</label>
              <textarea
                id="processPageUrl"
                class="form-control small-textarea"
                placeholder="可输入一个或多个页面 URL，每行一个，例如：&#10;https://hsex.men/xxx&#10;https://hsex.men/yyy"
              ></textarea>
            </div>
            <div class="col-md-3">
              <label class="form-label">输出目录（可选）</label>
              <input
                id="processOutputDir"
                type="text"
                class="form-control"
                placeholder="留空则使用全局默认或后端默认"
              />
            </div>
            <div class="col-md-3 d-grid">
              <button id="btnProcess" class="btn btn-primary">
                开始一键处理
              </button>
            </div>
          </div>

          <div class="mt-3">
            <label class="form-label">存储方式（storage）</label>
            <div class="row g-3">
              <div class="col-md-3">
                <select id="processStorageType" class="form-select storage-type-select" data-context="process">
                  <option value="local" selected>本地（local）</option>
                  <option value="s3">S3</option>
                  <option value="webdav">WebDAV</option>
                  <option value="ftp">FTP</option>
                </select>
              </div>
              <div class="col-md-9">
                <!-- local 提示 -->
                <div class="storage-section" data-context="process" data-type="local">
                  <div class="form-text text-info">
                    默认使用 <code>{"type":"local"}</code>，文件保存在后端本地，并返回一次性下载链接。
                  </div>
                </div>

                <!-- S3 配置 -->
                <div class="storage-section d-none" data-context="process" data-type="s3">
                  <div class="row g-2 mb-2">
                    <div class="col-md-4">
                      <label class="form-label">Region</label>
                      <input id="processStorageS3Region" type="text" class="form-control" placeholder="us-east-1" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Bucket</label>
                      <input id="processStorageS3Bucket" type="text" class="form-control" placeholder="your-bucket" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Key</label>
                      <input id="processStorageS3Key" type="text" class="form-control" placeholder="path/in/bucket/video.ts" />
                    </div>
                  </div>
                  <div class="row g-2 mb-2">
                    <div class="col-md-6">
                      <label class="form-label">Access Key ID</label>
                      <input id="processStorageS3AccessKeyId" type="text" class="form-control" />
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Secret Access Key</label>
                      <input id="processStorageS3SecretAccessKey" type="password" class="form-control" />
                    </div>
                  </div>
                  <div class="row g-2 align-items-center">
                    <div class="col-md-8">
                      <label class="form-label">Endpoint（可选）</label>
                      <input id="processStorageS3Endpoint" type="text" class="form-control" placeholder="https://s3.your-provider.com" />
                    </div>
                    <div class="col-md-4 form-check mt-3">
                      <input id="processStorageS3ForcePathStyle" class="form-check-input" type="checkbox" />
                      <label class="form-check-label" for="processStorageS3ForcePathStyle">
                        forcePathStyle
                      </label>
                    </div>
                  </div>
                </div>

                <!-- WebDAV 配置 -->
                <div class="storage-section d-none" data-context="process" data-type="webdav">
                  <div class="row g-2 mb-2">
                    <div class="col-md-6">
                      <label class="form-label">URL</label>
                      <input id="processStorageWebdavUrl" type="text" class="form-control" placeholder="https://webdav.example.com" />
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">用户名</label>
                      <input id="processStorageWebdavUsername" type="text" class="form-control" />
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">密码</label>
                      <input id="processStorageWebdavPassword" type="password" class="form-control" />
                    </div>
                  </div>
                  <div class="row g-2">
                    <div class="col-12">
                      <label class="form-label">远程路径</label>
                      <input id="processStorageWebdavRemotePath" type="text" class="form-control" placeholder="/path/on/server/video.ts" />
                    </div>
                  </div>
                </div>

                <!-- FTP 配置 -->
                <div class="storage-section d-none" data-context="process" data-type="ftp">
                  <div class="row g-2 mb-2">
                    <div class="col-md-4">
                      <label class="form-label">Host</label>
                      <input id="processStorageFtpHost" type="text" class="form-control" placeholder="ftp.example.com" />
                    </div>
                    <div class="col-md-2">
                      <label class="form-label">Port</label>
                      <input id="processStorageFtpPort" type="number" class="form-control" placeholder="21" />
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">User</label>
                      <input id="processStorageFtpUser" type="text" class="form-control" />
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Password</label>
                      <input id="processStorageFtpPassword" type="password" class="form-control" />
                    </div>
                  </div>
                  <div class="row g-2 align-items-center">
                    <div class="col-md-6">
                      <label class="form-label">远程路径</label>
                      <input id="processStorageFtpRemotePath" type="text" class="form-control" placeholder="/path/on/server/video.ts" />
                    </div>
                    <div class="col-md-3 form-check mt-3">
                      <input id="processStorageFtpSecure" class="form-check-input" type="checkbox" />
                      <label class="form-check-label" for="processStorageFtpSecure">
                        secure
                      </label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 仅解析 M3U8 -->
        <div id="tab-parse" class="tab-pane d-none">
          <div class="row g-3 align-items-end">
            <div class="col-md-8">
              <label class="form-label">页面 URL</label>
              <input
                id="parsePageUrl"
                type="text"
                class="form-control"
                placeholder="例如：https://hsex.men/..."
              />
            </div>
            <div class="col-md-4 d-grid">
              <button id="btnParse" class="btn btn-success">
                开始解析
              </button>
            </div>
          </div>
          <div class="mt-3">
            <label class="form-label">解析结果（M3U8 列表）</label>
            <textarea
              id="parseResult"
              class="form-control small-textarea"
              readonly
            ></textarea>
            <div class="form-text text-info">
              可从中复制一个 M3U8 URL，用于“仅下载 M3U8”。
            </div>
          </div>
        </div>

        <!-- 仅下载 M3U8 -->
        <div id="tab-download" class="tab-pane d-none">
          <div class="row g-3 align-items-end">
            <div class="col-md-6">
              <label class="form-label">M3U8 URL</label>
              <input
                id="downloadM3u8Url"
                type="text"
                class="form-control"
                placeholder="例如：https://example.com/file.m3u8"
              />
            </div>
            <div class="col-md-3">
              <label class="form-label">输出目录（可选）</label>
              <input
                id="downloadOutputDir"
                type="text"
                class="form-control"
                placeholder="留空则使用全局默认或后端默认"
              />
            </div>
            <div class="col-md-3 d-grid">
              <button id="btnDownload" class="btn btn-warning">
                开始下载
              </button>
            </div>
          </div>

          <div class="mt-3">
            <label class="form-label">存储方式（storage）</label>
            <div class="row g-3">
              <div class="col-md-3">
                <select id="downloadStorageType" class="form-select storage-type-select" data-context="download">
                  <option value="local" selected>本地（local）</option>
                  <option value="s3">S3</option>
                  <option value="webdav">WebDAV</option>
                  <option value="ftp">FTP</option>
                </select>
              </div>
              <div class="col-md-9">
                <!-- local 提示 -->
                <div class="storage-section" data-context="download" data-type="local">
                  <div class="form-text text-info">
                    默认使用 <code>{"type":"local"}</code>，文件保存在后端本地，并返回一次性下载链接。
                  </div>
                </div>

                <!-- S3 配置 -->
                <div class="storage-section d-none" data-context="download" data-type="s3">
                  <div class="row g-2 mb-2">
                    <div class="col-md-4">
                      <label class="form-label">Region</label>
                      <input id="downloadStorageS3Region" type="text" class="form-control" placeholder="us-east-1" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Bucket</label>
                      <input id="downloadStorageS3Bucket" type="text" class="form-control" placeholder="your-bucket" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Key</label>
                      <input id="downloadStorageS3Key" type="text" class="form-control" placeholder="path/in/bucket/video.ts" />
                    </div>
                  </div>
                  <div class="row g-2 mb-2">
                    <div class="col-md-6">
                      <label class="form-label">Access Key ID</label>
                      <input id="downloadStorageS3AccessKeyId" type="text" class="form-control" />
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Secret Access Key</label>
                      <input id="downloadStorageS3SecretAccessKey" type="password" class="form-control" />
                    </div>
                  </div>
                  <div class="row g-2 align-items-center">
                    <div class="col-md-8">
                      <label class="form-label">Endpoint（可选）</label>
                      <input id="downloadStorageS3Endpoint" type="text" class="form-control" placeholder="https://s3.your-provider.com" />
                    </div>
                    <div class="col-md-4 form-check mt-3">
                      <input id="downloadStorageS3ForcePathStyle" class="form-check-input" type="checkbox" />
                      <label class="form-check-label" for="downloadStorageS3ForcePathStyle">
                        forcePathStyle
                      </label>
                    </div>
                  </div>
                </div>

                <!-- WebDAV 配置 -->
                <div class="storage-section d-none" data-context="download" data-type="webdav">
                  <div class="row g-2 mb-2">
                    <div class="col-md-6">
                      <label class="form-label">URL</label>
                      <input id="downloadStorageWebdavUrl" type="text" class="form-control" placeholder="https://webdav.example.com" />
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">用户名</label>
                      <input id="downloadStorageWebdavUsername" type="text" class="form-control" />
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">密码</label>
                      <input id="downloadStorageWebdavPassword" type="password" class="form-control" />
                    </div>
                  </div>
                  <div class="row g-2">
                    <div class="col-12">
                      <label class="form-label">远程路径</label>
                      <input id="downloadStorageWebdavRemotePath" type="text" class="form-control" placeholder="/path/on/server/video.ts" />
                    </div>
                  </div>
                </div>

                <!-- FTP 配置 -->
                <div class="storage-section d-none" data-context="download" data-type="ftp">
                  <div class="row g-2 mb-2">
                    <div class="col-md-4">
                      <label class="form-label">Host</label>
                      <input id="downloadStorageFtpHost" type="text" class="form-control" placeholder="ftp.example.com" />
                    </div>
                    <div class="col-md-2">
                      <label class="form-label">Port</label>
                      <input id="downloadStorageFtpPort" type="number" class="form-control" placeholder="21" />
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">User</label>
                      <input id="downloadStorageFtpUser" type="text" class="form-control" />
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Password</label>
                      <input id="downloadStorageFtpPassword" type="password" class="form-control" />
                    </div>
                  </div>
                  <div class="row g-2 align-items-center">
                    <div class="col-md-6">
                      <label class="form-label">远程路径</label>
                      <input id="downloadStorageFtpRemotePath" type="text" class="form-control" placeholder="/path/on/server/video.ts" />
                    </div>
                    <div class="col-md-3 form-check mt-3">
                      <input id="downloadStorageFtpSecure" class="form-check-input" type="checkbox" />
                      <label class="form-check-label" for="downloadStorageFtpSecure">
                        secure
                      </label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 健康检查 & 日志输出 -->
    <div class="row g-3 mb-3">
      <div class="col-md-4">
        <div class="card shadow-sm h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            健康检查 - GET /health
            <button id="btnHealth" class="btn btn-sm btn-outline-dark">
              检查
            </button>
          </div>
          <div class="card-body">
            <pre id="healthResult" class="small mb-0 text-wrap"></pre>
          </div>
        </div>
      </div>
      <div class="col-md-8">
        <div class="card shadow-sm h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            请求 / 响应日志
            <button id="btnClearLog" class="btn btn-sm btn-outline-light">
              清空日志
            </button>
          </div>
          <div class="card-body log-container">
            <pre id="logOutput" class="small mb-0"></pre>
          </div>
        </div>
      </div>
    </div>

    <!-- 简易下载历史 -->
    <div class="card mb-3 shadow-sm">
      <div class="card-header">
        下载记录（本页面会话内）
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-dark table-striped align-middle mb-0">
            <thead>
              <tr>
                <th>时间</th>
                <th>类型</th>
                <th>源</th>
                <th>状态</th>
                <th>下载链接</th>
              </tr>
            </thead>
            <tbody id="historyTableBody">
              <!-- 动态填充 -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <footer class="text-center text-secondary mt-4 small">
      前端 Web UI，仅作为 <code>91-download-api</code> 的可视化客户端使用。请确保本页面所在域名已被后端 CORS 允许。
    </footer>
  </div>

  <script src="app.js"></script>
</body>
</html>


